mics_hl <- read_sav(file.path(mics_dir, "hl.sav"))  # Household listing
mics_ch <- read_sav(file.path(mics_dir, "ch.sav"))  # Children under 5
mics_fs <- read_sav(file.path(mics_dir, "fs.sav"))  # Foundational learning skills
# Select key household variables for merging
hh_merge <- mics_hh %>%
select(
HH1, HH2,                           # Cluster and household number (merge keys)
HH6,                                 # Area (urban/rural)
HH7,                                 # Region
DISTRICT,                            # District
starts_with("windex"),               # Wealth indices
wscore,                              # Wealth score
hhweight                             # Household weight
) %>%
mutate(
area = as_factor(HH6),
region = as_factor(HH7),
wealth_quintile = as_factor(windex5)
)
# Merge household context into each MICS dataset
mics_merged <- mics_hl %>%
left_join(hh_merge, by = c("HH1", "HH2"))
mics_children <- mics_ch %>%
left_join(hh_merge, by = c("HH1", "HH2"))
mics_skills <- mics_fs %>%
left_join(hh_merge, by = c("HH1", "HH2"))
message(sprintf("  MICS households: %s", format(n_distinct(paste(mics_hh$HH1, mics_hh$HH2)), big.mark = ",")))
message(sprintf("  MICS individuals: %s", format(nrow(mics_merged), big.mark = ",")))
message(sprintf("  MICS children (under 5): %s", format(nrow(mics_children), big.mark = ",")))
message(sprintf("  MICS foundational skills: %s", format(nrow(mics_skills), big.mark = ",")))
# =============================================================================
# 3. LOAD GIS DATA
# =============================================================================
message("\nLoading GIS data...")
# MICS cluster GPS coordinates
gps_clusters <- st_read(
file.path(gps_dir, "GPS Datasets", "MalawiMICS2019-20GPS.shp"),
quiet = TRUE
)
# Survey boundaries
boundaries <- st_read(
file.path(gps_dir, "Survey Boundaries", "Shapefiles", "mics_boundaries.shp"),
quiet = TRUE
)
# District boundaries (for mapping)
district_boundaries <- st_read(
file.path(gps_dir, "Survey Boundaries", "Shapefiles", "mics_boundaries3.shp"),
quiet = TRUE
)
# Geospatial covariates (environmental variables by cluster)
geo_covariates <- read_excel(
file.path(gps_dir, "Geospatial Covariates", "MalawiMICS2019-20GeoCov.xlsx"),
sheet = "Data - Cluster"
)
message(sprintf("  GPS clusters: %d", nrow(gps_clusters)))
message(sprintf("  Survey boundaries: %d", nrow(boundaries)))
message(sprintf("  Geospatial covariate records: %d", nrow(geo_covariates)))
# =============================================================================
# 4. MERGE MICS WITH GIS
# =============================================================================
message("\nMerging MICS with GIS data...")
# Join geo covariates to skills data via cluster number
mics_skills_geo <- mics_skills |>
left_join(geo_covariates, by = c("HH1" = "cluster"))
message(sprintf("  MICS skills with geo covariates: %s", format(nrow(mics_skills_geo), big.mark = ",")))
# =============================================================================
# 5. CONSTRUCT ANALYSIS DATASETS
# =============================================================================
message("\nConstructing analysis datasets...")
# Get DISTRICT and hhweight from household file for merging
hh_extra <- mics_hh %>%
select(HH1, HH2, DISTRICT, hhweight) %>%
distinct()
# --- Out-of-school rate data (primary school age 6-13) ---
# ED9: attended school current year (1 = Yes, 2 = No)
# HL4: sex (1 = Male, 2 = Female)
# HL12: mother alive (2 = No), HL16: father alive (2 = No)
# helevel: HH head education (0 = none, 1 = primary, 2+ = secondary or higher)
# fsdisability: 1 = has functional difficulty
oosr_data <- mics_hl %>%
filter(schage >= 6, schage <= 13) %>%
select(-any_of("hhweight")) %>%  # Remove if it exists in mics_hl
left_join(hh_extra, by = c("HH1", "HH2")) %>%
left_join(
mics_fs %>% select(HH1, HH2, LN, fsdisability),
by = c("HH1", "HH2", "HL1" = "LN")
) %>%
transmute(
HH1, HH2,
weight = hhweight,
HH1, HH2,
weight = hhweight,
out_of_school = if_else(as.numeric(ED9) == 1, 0L, 1L),
sex = as_factor(HL4),
age = as.numeric(schage),
area = as_factor(HH6),
wealth_quintile = as_factor(windex5),
orphan = as.integer(
coalesce(as.numeric(HL12) == 2, FALSE) |
coalesce(as.numeric(HL16) == 2, FALSE)
),
disabled = if_else(as.numeric(fsdisability) == 1, 1L, 0L, missing = 0L),
hh_head_completed_primary = if_else(as.numeric(helevel) >= 2, 1L, 0L, missing = 0L),
district_code = as.numeric(DISTRICT),
district_name = trimws(as_factor(DISTRICT))
)
# --- Foundational reading data (from MICS foundational skills module) ---
# FL20A/B: English story words attempted/wrong
# FL22A-E: English comprehension
# FLB20A/B, FLB22A-E: Chichewa equivalents
# Foundational reading = >= 90% words correct AND >= 3/5 comprehension
reading_data <- mics_fs %>%
left_join(
mics_hh %>% select(HH1, HH2, DISTRICT, helevel, hhweight) %>% distinct(),
by = c("HH1", "HH2")
) %>%
filter(as.numeric(FL28) == 1, schage >= 5, schage <= 17) %>%
mutate(
# English story reading
eng_attempted = na_if(as.numeric(FL20A), 99),
eng_wrong     = na_if(as.numeric(FL20B), 99),
eng_pct_correct = if_else(
!is.na(eng_attempted) & eng_attempted > 0,
(eng_attempted - replace_na(eng_wrong, 0)) / eng_attempted, 0
),
eng_comp = rowSums(across(
c(FL22A, FL22B, FL22C, FL22D, FL22E),
~ coalesce(as.numeric(.) == 1, FALSE)
)),
# Chichewa story reading
chi_attempted = na_if(as.numeric(FLB20A), 99),
chi_wrong     = na_if(as.numeric(FLB20B), 99),
chi_pct_correct = if_else(
!is.na(chi_attempted) & chi_attempted > 0,
(chi_attempted - replace_na(chi_wrong, 0)) / chi_attempted, 0
),
chi_comp = rowSums(across(
c(FLB22A, FLB22B, FLB22C, FLB22D, FLB22E),
~ coalesce(as.numeric(.) == 1, FALSE)
)),
# Can read = meets criteria in either language
can_read = as.integer(
(eng_pct_correct >= 0.9 & eng_comp >= 3) |
(chi_pct_correct >= 0.9 & chi_comp >= 3)
)
) %>%
transmute(
HH1, HH2,
weight = hhweight,
can_read,
sex = as_factor(HL4),
age = as.numeric(schage),
area = as_factor(HH6),
wealth_quintile = as_factor(windex5),
disabled = if_else(as.numeric(fsdisability) == 1, 1L, 0L, missing = 0L),
district_code = as.numeric(DISTRICT),
district_name = trimws(as_factor(DISTRICT))
)
message(sprintf("  OOSR data: %s children aged 6-13", format(nrow(oosr_data), big.mark = ",")))
message(sprintf("  Reading data: %s children aged 5-17", format(nrow(reading_data), big.mark = ",")))
# =============================================================================
# 6. SAVE PROCESSED DATA
# =============================================================================
message("\nSaving processed data...")
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)
# IHS datasets
write_csv(ihs_merged, file.path(output_dir, "ihs_households.csv"))
write_csv(ihs_education_full, file.path(output_dir, "ihs_education.csv"))
# MICS datasets
write_csv(mics_merged, file.path(output_dir, "mics_individuals.csv"))
write_csv(mics_children, file.path(output_dir, "mics_children.csv"))
write_csv(mics_skills_geo, file.path(output_dir, "mics_skills_geo.csv"))
# Analysis datasets
write_csv(oosr_data, file.path(output_dir, "oosr_data.csv"))
write_csv(reading_data, file.path(output_dir, "reading_data.csv"))
# GIS data
st_write(gps_clusters, file.path(output_dir, "mics_clusters.geojson"), delete_dsn = TRUE, quiet = TRUE)
st_write(boundaries, file.path(output_dir, "survey_boundaries.geojson"), delete_dsn = TRUE, quiet = TRUE)
st_write(district_boundaries, file.path(output_dir, "district_boundaries.geojson"), delete_dsn = TRUE, quiet = TRUE)
message("\nDone - Data preparation complete")
library(broom)
# =============================================================================
# 02_analysis.R
# Analysis: summary tables, regressions, and district aggregates
# =============================================================================
library(tidyverse)
library(broom)
# Run data prep first (or comment out if already run and loading from CSVs)
# source("scripts/01_data_preparation.R")
output_dir <- "outputs"
dir.create(file.path(output_dir, "tables"), showWarnings = FALSE, recursive = TRUE)
# =============================================================================
# 1. SUMMARY TABLE: OOSR and Foundational Learning by group and wealth quintile
# =============================================================================
#
# 1.1 OOSR Summary Table
#
# Weighted OOSR for a filtered subset
calc_oosr <- function(data) {
if (nrow(data) == 0) return(NA_real_)
weighted.mean(data$out_of_school, data$weight, na.rm = TRUE) * 100
}
# Build one row of the summary table
oosr_row <- function(data, label) {
tibble(
group     = label,
oosr_pct  = calc_oosr(data),
oosr_q1   = calc_oosr(filter(data, wealth_quintile == "Poorest")),
oosr_q5   = calc_oosr(filter(data, wealth_quintile == "Richest")),
n         = nrow(data)
)
}
summary_table <- bind_rows(
oosr_row(filter(oosr_data, area == "Rural", sex == "Male"),   "Rural Boys"),
oosr_row(filter(oosr_data, area == "Rural", sex == "Female"), "Rural Girls"),
oosr_row(filter(oosr_data, area == "Urban", sex == "Male"),   "Urban Boys"),
oosr_row(filter(oosr_data, area == "Urban", sex == "Female"), "Urban Girls"),
oosr_row(filter(oosr_data, disabled == 1),                    "Disabled"),
oosr_row(filter(oosr_data, orphan == 1),                      "Orphaned"),
oosr_row(filter(oosr_data, hh_head_completed_primary == 1),   "HH Head Completed School")
) %>%
mutate(across(where(is.numeric) & !c(n), ~ round(., 1)))
cat("\n=== Out-of-School Rate (%) by Group ===\n\n")
print(as.data.frame(summary_table), row.names = FALSE)
write_csv(summary_table, file.path(output_dir, "tables/summary_table_oosr.csv"))
#
# 1.2 Foundational Reading Summary Table
#
# Weighted Foundational Reading rate for a filtered subset
calc_reading <- function(data) {
if (nrow(data) == 0) return(NA_real_)
weighted.mean(data$can_read, data$weight, na.rm = TRUE) * 100
}
# Build one row of the summary table
reading_row <- function(data, label) {
tibble(
group       = label,
reading_pct = calc_reading(data),
reading_q1  = calc_reading(filter(data, wealth_quintile == "Poorest")),
reading_q5  = calc_reading(filter(data, wealth_quintile == "Richest")),
n           = nrow(data)
)
}
reading_summary_table <- bind_rows(
reading_row(reading_data,                                        "Overall"),
reading_row(filter(reading_data, area == "Rural", sex == "Male"),   "Rural Boys"),
reading_row(filter(reading_data, area == "Rural", sex == "Female"), "Rural Girls"),
reading_row(filter(reading_data, area == "Urban", sex == "Male"),   "Urban Boys"),
reading_row(filter(reading_data, area == "Urban", sex == "Female"), "Urban Girls"),
reading_row(filter(reading_data, disabled == 1),                    "Disabled"),
reading_row(filter(reading_data, disabled == 1, sex == "Male"),     "Disabled Boys"),
reading_row(filter(reading_data, disabled == 1, sex == "Female"),   "Disabled Girls")
) %>%
mutate(across(where(is.numeric) & !c(n), ~ round(., 1)))
cat("\n=== Foundational Reading (%) by Group ===\n\n")
print(as.data.frame(reading_summary_table), row.names = FALSE)
write_csv(reading_summary_table, file.path(output_dir, "tables/summary_table_foundational_reading.csv"))
# =============================================================================
# 2. Summary Dataframes
# =============================================================================
# OOSR by sex, area, wealth quintile
oosr_by_group <- oosr_data %>%
group_by(sex, area, wealth_quintile) %>%
summarise(
oosr_pct = weighted.mean(out_of_school, weight, na.rm = TRUE) * 100,
n = n(),
.groups = "drop"
)
# Foundational reading by sex, area, wealth quintile (ages 7-14)
reading_by_group <- reading_data %>%
filter(age >= 7, age <= 14) %>%
group_by(sex, area, wealth_quintile) %>%
summarise(
pct_can_read = weighted.mean(can_read, weight, na.rm = TRUE) * 100,
n = n(),
.groups = "drop"
)
# Combined dataframe
education_df <- oosr_by_group %>%
full_join(reading_by_group,
by = c("sex", "area", "wealth_quintile"),
suffix = c("_oosr", "_reading"))
write_csv(education_df, file.path(output_dir, "tables/education_indicators.csv"))
# =============================================================================
# 3. DISTRICT-LEVEL AGGREGATES
# =============================================================================
district_oosr <- oosr_data %>%
group_by(district_code, district_name) %>%
summarise(
oosr_pct = weighted.mean(out_of_school, weight, na.rm = TRUE) * 100,
n_oosr = n(),
.groups = "drop"
)
district_reading <- reading_data %>%
filter(age >= 7, age <= 14) %>%
group_by(district_code, district_name) %>%
summarise(
pct_can_read = weighted.mean(can_read, weight, na.rm = TRUE) * 100,
n_reading = n(),
.groups = "drop"
)
district_stats <- district_oosr %>%
inner_join(district_reading, by = c("district_code", "district_name")) %>%
mutate(pct_cannot_read = 100 - pct_can_read)
write_csv(district_stats, file.path(output_dir, "tables/district_stats.csv"))
# =============================================================================
# 4. REGRESSIONS
# =============================================================================
#
# 4.1 OOSR Regression
#
oosr_data_clean <- oosr_data %>%
mutate(
# Outcome as factor (0 = not out of school, 1 = out of school)
out_of_school = factor(out_of_school, levels = c(0, 1)),
# Categorical predictors
sex   = factor(sex),
area  = factor(area),
wealth_quintile = factor(
wealth_quintile,
levels = c("Poorest", "Second", "Middle", "Fourth", "Richest")
),
orphan  = factor(orphan, levels = c(0, 1)),
disabled = factor(disabled, levels = c(0, 1)),
hh_head_completed_primary = factor(hh_head_completed_primary,
levels = c(0, 1))
)
#Setting Reference Values
oosr_data_clean <- oosr_data_clean %>%
mutate(
sex = relevel(sex, ref = "Male"),
area = relevel(area, ref = "Urban"),
wealth_quintile = relevel(wealth_quintile, ref = "Poorest"),
orphan = relevel(orphan, ref = "0"),
disabled = relevel(disabled, ref = "0"),
hh_head_completed_primary = relevel(hh_head_completed_primary, ref = "0")
)
#Running Logistic Regression
oos_model <- glm(
out_of_school ~ age +
sex +
area +
wealth_quintile +
orphan +
disabled +
hh_head_completed_primary,
data = oosr_data_clean,
family = binomial(link = "logit")
)
write_csv(
tidy(oos_model, exponentiate = TRUE, conf.int = TRUE) %>%
filter(term != "(Intercept)") %>%
mutate(
OR = round(estimate, 2),
CI = paste0(round(conf.low, 2), " – ", round(conf.high, 2)),
p.value = round(p.value, 3)
) %>%
select(term, OR, CI, p.value),
file.path(output_dir, "tables/oosr_regression.csv")
)
#
# 4.2 Foundational Reading Regression
#
reading_data_clean <- reading_data %>%
mutate(
# Outcome as factor (0 = can't read, 1 = can read)
out_of_school = factor(can_read, levels = c(0, 1)),
# Categorical predictors
sex   = factor(sex),
area  = factor(area),
wealth_quintile = factor(
wealth_quintile,
levels = c("Poorest", "Second", "Middle", "Fourth", "Richest")
),
disabled = factor(disabled, levels = c(0, 1))
)
#Setting Reference Values
reading_data_clean  <-  reading_data_clean %>%
mutate(
sex = relevel(sex, ref = "Male"),
area = relevel(area, ref = "Urban"),
wealth_quintile = relevel(wealth_quintile, ref = "Poorest"),
disabled = relevel(disabled, ref = "0")
)
#Running Regression
reading_model <- glm(
can_read ~ age +
sex +
area +
wealth_quintile +
disabled
,
data = reading_data_clean,
family = binomial(link = "logit")
)
write_csv(
tidy(reading_model, exponentiate = TRUE, conf.int = TRUE) %>%
filter(term != "(Intercept)") %>%
mutate(
OR = round(estimate, 2),
CI = paste0(round(conf.low, 2), " – ", round(conf.high, 2)),
p.value = round(p.value, 3)
) %>%
select(term, OR, CI, p.value),
file.path(output_dir, "tables/reading_regression.csv")
)
message("\nAnalysis complete - tables saved to 'outputs/tables/'")
# =============================================================================
# 03_outputs.R
# Charts and maps for Malawi education analysis
# =============================================================================
library(tidyverse)
library(sf)
# Run analysis first (or comment out if already run)
# source("scripts/02_analysis.R")
output_dir <- "outputs"
dir.create(file.path(output_dir, "figures"), showWarnings = FALSE, recursive = TRUE)
dir.create(file.path(output_dir, "maps"), showWarnings = FALSE, recursive = TRUE)
# =============================================================================
# 1. PLOTS
# =============================================================================
# Wealth, Sex and Foundational Learning - weighted average across urban/rural
education_gender_summary <- education_df %>%
group_by(sex, wealth_quintile) %>%
summarise(
pct_can_read = weighted.mean(pct_can_read, n_reading, na.rm = TRUE),
.groups = "drop"
)
ggplot(education_gender_summary, aes(x = wealth_quintile, y = pct_can_read, fill = sex)) +
geom_col(position = "dodge") +
geom_text(
aes(label = round(pct_can_read, 1)),
position = position_dodge(width = 0.9),
vjust = -0.5,
size = 3
) +
labs(
title = "Foundational Learning by Sex and Household Wealth Quintile",
x = "Wealth Quintile",
y = "% of 6-13 year olds who can read",
fill = "Sex"
) +
scale_fill_manual(
values = c("#00AEEF", "#FFC20E"),
labels = c("Female", "Male")
) +
theme_minimal() +
theme(
legend.box.background = element_rect(colour = "grey80"),
panel.grid.major.x = element_blank()
)
ggsave(file.path(output_dir, "figures/foundational_sex_chart.png"), width = 6, height = 4, dpi = 300)
# Wealth, Area and Foundational Learning - weighted average across urban/rural
education_area_summary <- education_df %>%
group_by(area, wealth_quintile) %>%
summarise(
pct_can_read = weighted.mean(pct_can_read, n_reading, na.rm = TRUE),
.groups = "drop"
)
ggplot(education_area_summary, aes(x = wealth_quintile, y = pct_can_read, fill = area)) +
geom_col(position = "dodge") +
geom_text(
aes(label = round(pct_can_read, 1)),
position = position_dodge(width = 0.9),
vjust = -0.5,
size = 3
) +
labs(
title = "Foundational Learning by Urban/Rural and Household Wealth Quintile",
x = "Wealth Quintile",
y = "% of 6-13 year olds who can read",
fill = "Area"
) +
scale_fill_manual(
values = c("#EE3224", "#A5cF4D")
) +
theme_minimal() +
theme(
legend.box.background = element_rect(colour = "grey80"),
panel.grid.major.x = element_blank()
)
ggsave(file.path(output_dir, "figures/foundational_area_chart.png"), width = 6, height = 4, dpi = 300)
# =============================================================================
# 2. DISTRICT MAPS
# =============================================================================
# Join stats to district boundaries
map_data <- district_boundaries %>%
mutate(district_code = as.numeric(GEOCODES)) %>%
left_join(district_stats, by = "district_code")
# --- Map 1: Out-of-school rate ---
ggplot(map_data) +
geom_sf(aes(fill = oosr_pct), colour = "white", linewidth = 0.3) +
scale_fill_distiller(
palette = "YlGn", direction = 1,
name = "Out of School Rate (%)"
) +
labs(title = "Out-of-School Rate by District (ages 6-13)") +
theme_void(base_size = 12) +
theme(legend.position = "right")
ggsave(file.path(output_dir, "maps/oosr.png"), width = 7, height = 9, dpi = 300)
# --- Map 2: % cannot read ---
ggplot(map_data) +
geom_sf(aes(fill = pct_cannot_read), colour = "white", linewidth = 0.3) +
scale_fill_distiller(
palette = "YlGnBu", direction = 1,
name = "Cannot\nRead (%)"
) +
labs(title = "Percentage of Children Who Cannot Read by District (ages 7-14)") +
theme_void(base_size = 12) +
theme(legend.position = "right")
ggsave(file.path(output_dir, "maps/cannot_read.png"), width = 7, height = 9, dpi = 300)
message("\nAll outputs saved to 'outputs/' directory")
